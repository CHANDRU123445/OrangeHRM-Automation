package Pages;
import jakarta.mail.*;
import jakarta.mail.internet.*;

import java.io.File;
import java.util.Properties;

import jakarta.activation.DataHandler;
import jakarta.activation.DataSource;
import jakarta.activation.FileDataSource;


public class EmailUtil {

    public static void sendEmailWithReports(String recipient, String htmlPath, String pdfPath) {
        final String fromEmail = "chandrubalu1998@gmail.com";         
        final String appPassword = "fowjppsegznggqfc"; // Use app password only

        // Check if the report files exist before sending
        File htmlFile = new File(htmlPath);
        File pdfFile = new File(pdfPath);

        if (!htmlFile.exists()) {
            System.out.println("HTML report not found at: " + htmlPath);
            return;
        }
        if (!pdfFile.exists()) {
            System.out.println(" PDF report not found at: " + pdfPath);
            return;
        }

        // Set up mail properties for Gmail SMTP
        Properties props = new Properties();
        props.put("mail.smtp.auth", "true");
        props.put("mail.smtp.starttls.enable", "true");
        props.put("mail.smtp.host", "smtp.gmail.com");
        props.put("mail.smtp.port", "587");

        // Create session
        Session session = Session.getInstance(props, new Authenticator() {
            protected PasswordAuthentication getPasswordAuthentication() {
                return new PasswordAuthentication(fromEmail, appPassword);
            }
        });

        try {
            // Email content
            Message message = new MimeMessage(session);
            message.setFrom(new InternetAddress(fromEmail));
            message.setRecipients(
                    Message.RecipientType.TO,
                    InternetAddress.parse(recipient)
            );
            message.setSubject(" Test Reports: HTML + PDF");

            // Body text
            MimeBodyPart textBodyPart = new MimeBodyPart();
            textBodyPart.setText("Hi,\n\nPlease find the attached HTML and PDF test reports.\n\nRegards,\nAutomation Team");

            // Attach HTML report
            MimeBodyPart htmlAttachment = new MimeBodyPart();
            DataSource sourceHtml = new FileDataSource(htmlFile);
            htmlAttachment.setDataHandler(new DataHandler(sourceHtml));
            htmlAttachment.setFileName(htmlFile.getName());

            // Attach PDF report
            MimeBodyPart pdfAttachment = new MimeBodyPart();
            DataSource sourcePdf = new FileDataSource(pdfFile);
            pdfAttachment.setDataHandler(new DataHandler(sourcePdf));
            pdfAttachment.setFileName(pdfFile.getName());

            // Combine all parts
            Multipart multipart = new MimeMultipart();
            multipart.addBodyPart(textBodyPart);
            multipart.addBodyPart(htmlAttachment);
            multipart.addBodyPart(pdfAttachment);

            // Set the complete message parts
            message.setContent(multipart);

            // Send message
            Transport.send(message);
            System.out.println("Email sent successfully with both reports to: " + recipient);
        } catch (MessagingException e) {
            System.out.println(" Failed to send email: " + e.getMessage());
            e.printStackTrace();
        }
    }
}
